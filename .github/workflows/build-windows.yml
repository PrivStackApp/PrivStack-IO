name: Build Windows (Signed + Deploy)

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      skip_deploy:
        description: 'Skip deploying to registry (build + sign only)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write   # Required for Azure OIDC login
  contents: read

env:
  DOTNET_VERSION: '9.0.x'
  RUST_VERSION: '1.85'

jobs:
  build-sign-deploy:
    runs-on: windows-latest
    steps:
      # ── Checkout ──────────────────────────────────────────────
      - name: Checkout PrivStack-IO
        uses: actions/checkout@v4
        with:
          path: PrivStack-IO

      - name: Checkout supporting-files
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/PrivStack
          sparse-checkout: supporting-files/scripts
          path: PrivStack-support

      # ── Setup toolchains ──────────────────────────────────────
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: PrivStack-IO/core -> PrivStack-IO/core/target

      # ── Install Inno Setup ────────────────────────────────────
      - name: Install Inno Setup
        run: |
          choco install innosetup -y --no-progress
        shell: cmd

      # ── Get app version from .csproj ──────────────────────────
      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $csproj = "PrivStack-IO/desktop/PrivStack.Desktop/PrivStack.Desktop.csproj"
          [xml]$xml = Get-Content $csproj
          $version = $xml.Project.PropertyGroup.Version | Where-Object { $_ }
          Write-Host "Version: $version"
          "APP_VERSION=$version" >> $env:GITHUB_OUTPUT

      # ── Build using build-msix.ps1 ───────────────────────────
      - name: Build Windows packages
        shell: pwsh
        run: |
          # build-msix.ps1 expects repo root structure
          # Copy the script to where it can find PrivStack-IO as a sibling
          $scriptSrc = "PrivStack-support/supporting-files/scripts"
          $scriptDest = "supporting-files/scripts"
          New-Item -ItemType Directory -Path $scriptDest -Force | Out-Null
          Copy-Item "$scriptSrc/*" $scriptDest -Recurse -Force

          & "$scriptDest/build-msix.ps1" `
            -Version "${{ steps.version.outputs.APP_VERSION }}" `
            -Configuration "${{ inputs.configuration }}"

      # ── Sign with Azure Artifact Signing ──────────────────────
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure Signing CLI extension
        run: az extension add --name artifact-signing --allow-preview true

      - name: Sign EXE installer
        shell: pwsh
        run: |
          $exePath = "PrivStack-IO/dist/msix/PrivStack-${{ steps.version.outputs.APP_VERSION }}-Setup.exe"
          if (Test-Path $exePath) {
            az artifact-signing sign `
              --account-name privstack `
              --certificate-profile-name privstack-signing `
              --resource-group privstack `
              --files $exePath
            Write-Host "Signed: $exePath" -ForegroundColor Green
          } else {
            Write-Host "WARNING: EXE installer not found at $exePath" -ForegroundColor Yellow
          }

      - name: Sign MSIX package
        shell: pwsh
        run: |
          $msixPath = "PrivStack-IO/dist/msix/PrivStack-${{ steps.version.outputs.APP_VERSION }}.msix"
          if (Test-Path $msixPath) {
            az artifact-signing sign `
              --account-name privstack `
              --certificate-profile-name privstack-signing `
              --resource-group privstack `
              --files $msixPath
            Write-Host "Signed: $msixPath" -ForegroundColor Green
          } else {
            Write-Host "WARNING: MSIX not found at $msixPath" -ForegroundColor Yellow
          }

      # ── Deploy to PrivStack registry ──────────────────────────
      - name: Deploy EXE to registry
        if: ${{ inputs.skip_deploy != true }}
        shell: bash
        env:
          PRIVSTACK_ADMIN_TOKEN: ${{ secrets.PRIVSTACK_ADMIN_TOKEN }}
          PRIVSTACK_API_URL: https://privstack.io
        run: |
          VERSION="${{ steps.version.outputs.APP_VERSION }}"
          EXE_PATH="PrivStack-IO/dist/msix/PrivStack-${VERSION}-Setup.exe"

          if [ ! -f "$EXE_PATH" ]; then
            echo "ERROR: EXE not found at $EXE_PATH"
            exit 1
          fi

          SIZE=$(wc -c < "$EXE_PATH" | tr -d ' ')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Uploading PrivStack-${VERSION}-Setup.exe (${SIZE_MB}MB)..."

          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/upload_response.txt \
            -X POST "${PRIVSTACK_API_URL}/api/admin/releases/publish" \
            -H "Authorization: Bearer ${PRIVSTACK_ADMIN_TOKEN}" \
            -F "package=@${EXE_PATH}" \
            -F "version=${VERSION}" \
            -F "platform=windows" \
            -F "arch=x64" \
            -F "format=exe" \
            -F "filename=PrivStack-${VERSION}-Setup.exe" \
          )

          BODY=$(cat /tmp/upload_response.txt)

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "Deployed OK ($HTTP_CODE)"
          else
            echo "FAILED ($HTTP_CODE): $BODY"
            exit 1
          fi

      # ── Upload artifacts to GitHub (backup) ───────────────────
      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: PrivStack-Windows-x64-EXE-${{ steps.version.outputs.APP_VERSION }}
          path: PrivStack-IO/dist/msix/PrivStack-${{ steps.version.outputs.APP_VERSION }}-Setup.exe
          retention-days: 30
          if-no-files-found: warn

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: PrivStack-Windows-x64-MSIX-${{ steps.version.outputs.APP_VERSION }}
          path: PrivStack-IO/dist/msix/PrivStack-${{ steps.version.outputs.APP_VERSION }}.msix
          retention-days: 30
          if-no-files-found: warn
