<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PrivStack.Desktop.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="400"
             x:Class="PrivStack.Desktop.Views.UpdatePanel"
             x:DataType="vm:UpdateViewModel">

    <Border Background="{DynamicResource ThemeSurfaceBrush}" CornerRadius="8" Padding="16">
        <Grid RowDefinitions="Auto,*,Auto">
            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,16">
                <TextBlock Text="Updates" FontSize="{DynamicResource ThemeFontSizeLg}" FontWeight="Bold" Foreground="{DynamicResource ThemeTextPrimaryBrush}"/>
                <TextBlock FontSize="{DynamicResource ThemeFontSizeXsSm}" Foreground="{DynamicResource ThemeTextMutedBrush}" Margin="0,4,0,0">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="Current: v{0}">
                            <Binding Path="CurrentVersion"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </StackPanel>

            <!-- Content -->
            <StackPanel Grid.Row="1" Spacing="12">
                <!-- Authentication required notice -->
                <Border Background="{DynamicResource ThemeSurfaceElevatedBrush}" CornerRadius="6" Padding="12"
                        IsVisible="{Binding NeedsAuthentication}">
                    <StackPanel Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="!" Foreground="{DynamicResource ThemeWarningBrush}" FontWeight="Bold"/>
                            <TextBlock Text="Sign in required"
                                       Foreground="{DynamicResource ThemeTextPrimaryBrush}" FontSize="{DynamicResource ThemeFontSizeSm}" FontWeight="SemiBold"/>
                        </StackPanel>
                        <TextBlock Text="Please log in via the setup wizard or Settings to download updates."
                                   Foreground="{DynamicResource ThemeTextMutedBrush}" FontSize="{DynamicResource ThemeFontSizeXsSm}" TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Update available -->
                <Border Background="{DynamicResource ThemeBackgroundBrush}" CornerRadius="6" Padding="12"
                        IsVisible="{Binding UpdateAvailable}">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Border Width="8" Height="8" Background="{DynamicResource ThemeSuccessBrush}" CornerRadius="4"/>
                            <TextBlock Text="Update Available" FontWeight="SemiBold" Foreground="{DynamicResource ThemeSuccessBrush}"/>
                        </StackPanel>
                        <TextBlock Foreground="{DynamicResource ThemeTextPrimaryBrush}" FontSize="{DynamicResource ThemeFontSizeSmMd}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="Version {0}">
                                    <Binding Path="UpdateVersion"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Download progress -->
                <StackPanel IsVisible="{Binding IsDownloading}" Spacing="8">
                    <TextBlock Text="Downloading update..." Foreground="{DynamicResource ThemeTextMutedBrush}" FontSize="{DynamicResource ThemeFontSizeSm}"/>
                    <ProgressBar Minimum="0" Maximum="100" Value="{Binding DownloadProgress}"
                                 Height="6" Background="{DynamicResource ThemeSurfaceElevatedBrush}" Foreground="{DynamicResource ThemePrimaryBrush}"
                                 CornerRadius="3"/>
                    <TextBlock Foreground="{DynamicResource ThemeTextMutedBrush}" FontSize="{DynamicResource ThemeFontSizeXsSm}" HorizontalAlignment="Right">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0}%">
                                <Binding Path="DownloadProgress"/>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>

                <!-- Status message -->
                <TextBlock Text="{Binding StatusMessage}" Foreground="{DynamicResource ThemeTextMutedBrush}" FontSize="{DynamicResource ThemeFontSizeSm}"
                           TextWrapping="Wrap"
                           IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                <!-- Update ready -->
                <Border Background="{DynamicResource ThemeSurfaceElevatedBrush}" CornerRadius="6" Padding="12"
                        IsVisible="{Binding UpdateReady}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Update downloaded and ready to install."
                                   Foreground="{DynamicResource ThemeTextPrimaryBrush}" FontSize="{DynamicResource ThemeFontSizeSm}" TextWrapping="Wrap"/>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Restart Now" Command="{Binding InstallAndRestartCommand}"
                                    Background="{DynamicResource ThemeSuccessBrush}" Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                    Padding="12,6" CornerRadius="4" FontSize="{DynamicResource ThemeFontSizeSm}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Actions -->
            <StackPanel Grid.Row="2" Spacing="8" Margin="0,16,0,0">
                <!-- Check for updates -->
                <Button Command="{Binding CheckForUpdatesCommand}"
                        Background="{DynamicResource ThemeSurfaceElevatedBrush}" Foreground="{DynamicResource ThemeTextPrimaryBrush}"
                        Padding="12,8" CornerRadius="4"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Check for Updates" FontSize="{DynamicResource ThemeFontSizeSm}"/>
                        <TextBlock Text="..." IsVisible="{Binding IsChecking}"/>
                    </StackPanel>
                </Button>

                <!-- Download update -->
                <Button Content="Download Update" Command="{Binding DownloadUpdateCommand}"
                        IsVisible="{Binding UpdateAvailable}"
                        IsEnabled="{Binding !IsDownloading}"
                        Background="{DynamicResource ThemePrimaryBrush}" Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                        Padding="12,8" CornerRadius="4"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
