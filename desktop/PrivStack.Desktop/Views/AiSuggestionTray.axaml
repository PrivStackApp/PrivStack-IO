<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:tray="using:PrivStack.Desktop.ViewModels.AiTray"
             xmlns:sdk="using:PrivStack.Sdk.Capabilities"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="500"
             x:Class="PrivStack.Desktop.Views.AiSuggestionTray"
             x:DataType="tray:AiSuggestionTrayViewModel">

    <UserControl.Resources>
        <!-- ═══ Shared Message Bubble Template ═══ -->
        <DataTemplate x:Key="MessageBubbleTemplate" x:DataType="tray:AiChatMessageViewModel">
            <Panel Margin="0,0,0,8">
                <!-- User Bubble (right-aligned) -->
                <Border IsVisible="{Binding IsUser}"
                        HorizontalAlignment="Right"
                        MaxWidth="320"
                        Background="{DynamicResource ThemePrimaryBrush}"
                        CornerRadius="12,12,4,12"
                        Padding="12,8">
                    <StackPanel Spacing="4">
                        <TextBlock Text="{Binding UserLabel}"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                   FontSize="{DynamicResource ThemeFontSizeSm}"/>
                        <Button IsVisible="{Binding HasSourceLink}"
                                Command="{Binding NavigateToSourceCommand}"
                                Background="Transparent" BorderThickness="0"
                                Padding="0" Cursor="Hand"
                                HorizontalAlignment="Left">
                            <TextBlock FontSize="{DynamicResource ThemeFontSizeXs}"
                                       Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                       Opacity="0.8"
                                       TextDecorations="Underline">
                                <Run Text="{Binding SourceEntityTitle, FallbackValue='this item'}"/>
                            </TextBlock>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- Assistant Bubble (left-aligned) -->
                <Border IsVisible="{Binding IsAssistant}"
                        HorizontalAlignment="Left"
                        MaxWidth="340"
                        Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                        CornerRadius="12,12,12,4"
                        Padding="12,8"
                        BorderBrush="{DynamicResource ThemeBorderSubtleBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="6">
                        <StackPanel Orientation="Horizontal" Spacing="8"
                                    IsVisible="{Binding IsLoading}">
                            <ProgressBar IsIndeterminate="True" Width="60" Height="3"/>
                            <TextBlock Text="Thinking..."
                                       FontSize="{DynamicResource ThemeFontSizeXs}"
                                       Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                        </StackPanel>

                        <Border IsVisible="{Binding IsError}"
                                Background="{DynamicResource ThemeDangerMutedBrush}"
                                CornerRadius="{DynamicResource ThemeRadiusSm}"
                                Padding="8,4">
                            <TextBlock Text="{Binding ErrorMessage}"
                                       FontSize="{DynamicResource ThemeFontSizeXs}"
                                       Foreground="{DynamicResource ThemeDangerBrush}"
                                       TextWrapping="Wrap"/>
                        </Border>

                        <TextBlock Text="{Binding Content}"
                                   IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   TextWrapping="Wrap"
                                   FontSize="{DynamicResource ThemeFontSizeSm}"
                                   Foreground="{DynamicResource ThemeTextSecondaryBrush}"/>

                        <ItemsControl ItemsSource="{Binding Actions}"
                                      IsVisible="{Binding IsReady}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="6"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="sdk:SuggestionAction">
                                    <Button Content="{Binding DisplayName}"
                                            Command="{Binding $parent[Border].((tray:AiChatMessageViewModel)DataContext).ExecuteActionCommand}"
                                            CommandParameter="{Binding}"
                                            Padding="8,4"
                                            FontSize="{DynamicResource ThemeFontSizeSm}"
                                            CornerRadius="{DynamicResource ThemeRadiusSm}"
                                            Cursor="Hand"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <StackPanel Orientation="Horizontal" Spacing="6"
                                    IsVisible="{Binding IsApplied}">
                            <TextBlock Text="Applied"
                                       FontSize="{DynamicResource ThemeFontSizeXs}"
                                       Foreground="{DynamicResource ThemeSuccessBrush}"
                                       VerticalAlignment="Center"/>
                            <ItemsControl ItemsSource="{Binding Actions}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="6"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="sdk:SuggestionAction">
                                        <Button Content="{Binding DisplayName}"
                                                Command="{Binding $parent[Border].((tray:AiChatMessageViewModel)DataContext).ExecuteActionCommand}"
                                                CommandParameter="{Binding}"
                                                Padding="8,4"
                                                FontSize="{DynamicResource ThemeFontSizeSm}"
                                                CornerRadius="{DynamicResource ThemeRadiusSm}"
                                                Cursor="Hand"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <Button IsVisible="{Binding SuggestionId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                Command="{Binding DismissCommand}"
                                Background="Transparent" BorderThickness="0"
                                Padding="0" Cursor="Hand"
                                HorizontalAlignment="Left">
                            <TextBlock Text="Dismiss"
                                       FontSize="{DynamicResource ThemeFontSizeXs}"
                                       Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                        </Button>
                    </StackPanel>
                </Border>
            </Panel>
        </DataTemplate>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*,Auto,Auto">

        <!-- ═══ Tab Strip ═══ -->
        <Border Grid.Row="0"
                Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                BorderBrush="{DynamicResource ThemeBorderSubtleBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="4">
                <Button Content="Chat"
                        Click="OnTabChat"
                        Padding="10,5"
                        FontSize="{DynamicResource ThemeFontSizeSm}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        Name="TabChat"/>
                <Button Content="Intents"
                        Click="OnTabIntents"
                        Padding="10,5"
                        FontSize="{DynamicResource ThemeFontSizeSm}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        Name="TabIntents"/>
                <Button Content="History"
                        Click="OnTabHistory"
                        Padding="10,5"
                        FontSize="{DynamicResource ThemeFontSizeSm}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        Name="TabHistory"/>
            </StackPanel>
        </Border>

        <!-- ═══ Chat Tab ═══ -->
        <Panel Grid.Row="1" Name="ChatPanel">
            <ScrollViewer Name="MessageScrollViewer" VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding ChatMessages}"
                              ItemTemplate="{StaticResource MessageBubbleTemplate}"
                              Margin="8"/>
            </ScrollViewer>

            <TextBlock Text="Start a conversation..."
                       IsVisible="{Binding !HasCards}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Margin="0,40"
                       FontSize="{DynamicResource ThemeFontSizeSm}"
                       Foreground="{DynamicResource ThemeTextMutedBrush}"/>
        </Panel>

        <!-- ═══ Intents Tab ═══ -->
        <Panel Grid.Row="1" Name="IntentsPanel" IsVisible="False">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding IntentMessages}"
                              ItemTemplate="{StaticResource MessageBubbleTemplate}"
                              Margin="8"/>
            </ScrollViewer>

            <TextBlock Text="No suggestions yet..."
                       IsVisible="{Binding !IntentMessages.Count}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Margin="0,40"
                       FontSize="{DynamicResource ThemeFontSizeSm}"
                       Foreground="{DynamicResource ThemeTextMutedBrush}"/>
        </Panel>

        <!-- ═══ History Tab ═══ -->
        <Panel Grid.Row="1" Name="HistoryPanel" IsVisible="False">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding ConversationHistory}" Margin="8">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="tray:ConversationSessionViewModel">
                            <Button Margin="0,0,0,4"
                                    Command="{Binding $parent[ItemsControl].((tray:AiSuggestionTrayViewModel)DataContext).LoadConversationCommand}"
                                    CommandParameter="{Binding}"
                                    Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                                    BorderBrush="{DynamicResource ThemeBorderSubtleBrush}"
                                    BorderThickness="1"
                                    CornerRadius="{DynamicResource ThemeRadiusSm}"
                                    Padding="10,8"
                                    HorizontalContentAlignment="Stretch"
                                    HorizontalAlignment="Stretch"
                                    Cursor="Hand">
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel Spacing="2">
                                        <TextBlock Text="{Binding Title}"
                                                   FontSize="{DynamicResource ThemeFontSizeSm}"
                                                   Foreground="{DynamicResource ThemeTextPrimaryBrush}"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxLines="1"/>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="{Binding TimeAgo}"
                                                       FontSize="{DynamicResource ThemeFontSizeXs}"
                                                       Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                                            <TextBlock FontSize="{DynamicResource ThemeFontSizeXs}"
                                                       Foreground="{DynamicResource ThemeTextMutedBrush}">
                                                <Run Text="{Binding MessageCount}"/>
                                                <Run Text="messages"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </StackPanel>
                                    <Button Grid.Column="1"
                                            Command="{Binding $parent[ItemsControl].((tray:AiSuggestionTrayViewModel)DataContext).DeleteConversationCommand}"
                                            CommandParameter="{Binding}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Padding="4"
                                            VerticalAlignment="Center"
                                            Cursor="Hand">
                                        <TextBlock Text="X"
                                                   FontSize="{DynamicResource ThemeFontSizeXs}"
                                                   Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                                    </Button>
                                </Grid>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <TextBlock Text="No conversations yet..."
                       IsVisible="{Binding !ConversationHistory.Count}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Margin="0,40"
                       FontSize="{DynamicResource ThemeFontSizeSm}"
                       Foreground="{DynamicResource ThemeTextMutedBrush}"/>
        </Panel>

        <!-- ═══ Token Warning Banner ═══ -->
        <Border Grid.Row="2"
                IsVisible="{Binding IsNearTokenLimit}"
                Background="{DynamicResource ThemeWarningMutedBrush}"
                Padding="10,6">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding TokenWarningText}"
                           FontSize="{DynamicResource ThemeFontSizeXs}"
                           Foreground="{DynamicResource ThemeWarningBrush}"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"/>
                <Button Grid.Column="1"
                        Content="New chat"
                        Command="{Binding StartNewChatCommand}"
                        Padding="8,3"
                        FontSize="{DynamicResource ThemeFontSizeXs}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        VerticalAlignment="Center"
                        Margin="6,0,0,0"
                        Cursor="Hand"/>
            </Grid>
        </Border>

        <!-- ═══ Chat Input Bar ═══ -->
        <Border Grid.Row="3"
                Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                BorderBrush="{DynamicResource ThemeBorderSubtleBrush}"
                BorderThickness="0,1,0,0"
                Padding="8">
            <Grid ColumnDefinitions="*,Auto">
                <TextBox Name="ChatInputBox"
                         Text="{Binding ChatInputText, Mode=TwoWay}"
                         Watermark="{Binding ChatWatermark}"
                         FontSize="{DynamicResource ThemeFontSizeSm}"
                         CornerRadius="{DynamicResource ThemeRadiusSm}"
                         Padding="8,6"
                         VerticalAlignment="Center"/>
                <Button Grid.Column="1"
                        Content="Send"
                        Command="{Binding SendChatMessageCommand}"
                        Background="{DynamicResource ThemePrimaryBrush}"
                        Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                        Padding="12,6"
                        Margin="6,0,0,0"
                        FontSize="{DynamicResource ThemeFontSizeSm}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        VerticalAlignment="Center"
                        Cursor="Hand"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
